---
layout: post
title: 单元测试的配置及思考
summary: 一直都听说单元测试是非常重要的模块，所以今天尝试着去配置了一下，在这记录配置时遇到的bug以及后续带来的思考
featured-img: 190221.jpg
labels: [记录]
---

### 前期准备：
**1.maven依赖**
```hgignore
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>

        <dependency>
            <groupId>junit</groupId>
            <artifactId>junit</artifactId>
            <scope>test</scope>
        </dependency>
```

**2.相关注解介绍**  
```hgignore
@RunWith(SpringJUnit4ClassRunner.class)  
这是JUnit的注解，通过这个注解让SpringJUnit4ClassRunner这个类提供Spring测试上下文。

@SpringBootTest  
该注解提供了两个属性用于配置：
    classes
        指定应用启动类，通常情况下无需设置，因为 SpringBoot 会自动搜索，直到找到 @SpringBootApplication 或 @SpringBootConfiguration 注解。
    webEnvironment
        指定Web应用环境，它可以是以下值
        MOCK：提供一个模拟的 Servlet 环境，内置的 Servlet 容器没有启动，配合可以与@AutoConfigureMockMvc 结合使用，用于基于 MockMvc 的应用程序测试。
        RANDOM_PORT：加载一个 EmbeddedWebApplicationContext 并提供一个真正嵌入式的 Servlet 环境，随机端口。
        DEFINED_PORT：加载一个 EmbeddedWebApplicationContext 并提供一个真正嵌入式的 Servlet 环境，默认端口 8080 或由配置文件指定。
        NONE：使用 SpringApplication 加载 ApplicationContext，但不提供任何 servlet 环境。
        
@Transactional  
在每个测试方法结束时会进行回滚操作
但是如果使用 RANDOM_PORT 或 DEFINED_PORT 这种真正的 Servlet 环境，HTTP 客户端和服务器将在不同的线程中运行，从而分离事务。 在这种情况下，在服务器上启动的任何事务都不会回滚。
```


















单元测试回滚
如果你添加了 @Transactional 注解，它会在每个测试方法结束时会进行回滚操作。

但是如果使用 RANDOM_PORT 或 DEFINED_PORT 这种真正的 Servlet 环境，HTTP 客户端和服务器将在不同的线程中运行，从而分离事务。 在这种情况下，在服务器上启动的任何事务都不会回滚。


注解	作用
@Test(excepted==xx.class,timeout=毫秒数)	修饰一个方法为测试方法，excepted参数可以忽略某些异常类
@Before	在每一个测试方法被运行前执行一次
@BeforeClass	在所有测试方法执行前执行
@After	在每一个测试方法运行后执行一次
@AfterClass	在所有测试方法执行后执行
@Ignore	修饰的类或方法会被测试运行器忽略
@RunWith	更改测试运行器





@SpringApplicationConfiguration(classes = 启动类.class)  
这是Spring Boot注解，为了进行集成测试，需要通过这个注解加载和配置Spring应用上下文。这是一个元注解（meta-annoation），它包含了@ContextConfiguration( loader = SpringApplicationContextLoader.class)这个注解，测试框架通过这个注解使用Spring Boot框架的SpringApplicationContextLoader加载器创建应用上下文。

@WebAppConfiguration   
表明是WEB应用环境，不能和@WebIntegrationTest一起使用

@WebIntegrationTest(“server.port:0”)  
这个注解表示当前的测试是集成测试（integration test），因此需要初始化完整的上下文并启动应用程序。这个注解一般和@SpringApplicationConfiguration一起出现。server.port:0指的是让Spring Boot在随机端口上启动Tomcat服务，随后在测试中程序通过@Value(“${local.server.port}”)获得这个端口号，并赋值给port变量。当在Jenkins或其他持续集成服务器上运行测试程序时，这种随机获取端口的能力可以提供测试程序的并行性。


**2.配置**  
确保有test的文件夹，如果没有则创建一下，必须在服务器启动层创建，且包名要相同
<img src="/assets/img/posts/unitTest.png" style="height: 600px;" />

然后在project structre 配置一下test文件夹
![nginx405](/assets/img/posts/unitTest3.png)

配置完以后在需要单元测试的类通过快捷键ctrl + shift + t 创建
![nginx405](/assets/img/posts/unitTest2.png)



